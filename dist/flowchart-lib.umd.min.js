/*! FlowchartLib v1.0.0 | MIT License */
/*!
 * FlowchartLib v1.0.0
 * (c) 2025
 * @license MIT
 */
!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():t.FlowchartLib=e()}("undefined"!=typeof self?self:this,function(){"use strict";class Node{constructor(t,e,i,s,n=""){this.id=t,this.type=e,this.x=i,this.y=s,this.text=n,this.width=120,this.height=60,this.selected=!1}containsPoint(t,e){return t>=this.x-this.width/2&&t<=this.x+this.width/2&&e>=this.y-this.height/2&&e<=this.y+this.height/2}isOnConnectionPoint(t,e,i=1){const s=this.getConnectionPoints(),n=10/i;for(let i of s)if(Math.sqrt((t-i.x)**2+(e-i.y)**2)<n)return i;return null}isOnResizeHandle(t,e,i=1){const s=this.getResizeHandles(),n=8/i;for(let i of s)if(Math.sqrt((t-i.x)**2+(e-i.y)**2)<n)return i;return null}getConnectionPoints(){return[{x:this.x,y:this.y-this.height/2,position:"top"},{x:this.x+this.width/2,y:this.y,position:"right"},{x:this.x,y:this.y+this.height/2,position:"bottom"},{x:this.x-this.width/2,y:this.y,position:"left"}]}getClosestConnectionPoint(t,e){const i=this.getConnectionPoints();let s=i[0],n=1/0;for(let o of i){const i=Math.sqrt((t-o.x)**2+(e-o.y)**2);i<n&&(n=i,s=o)}return s}getResizeHandles(){const t=this.x-this.width/2,e=this.x+this.width/2,i=this.y-this.height/2,s=this.y+this.height/2;return[{x:t,y:i,position:"top-left"},{x:e,y:i,position:"top-right"},{x:e,y:s,position:"bottom-right"},{x:t,y:s,position:"bottom-left"}]}draw(t,e=!1){switch(t.save(),t.fillStyle=this.getFillColor(),t.strokeStyle=e?"#2196F3":"#333",t.lineWidth=e?3:2,this.type){case"start":case"end":this.drawRounded(t);break;case"process":default:this.drawRectangle(t);break;case"decision":this.drawDiamond(t)}this.drawText(t),this.drawConnectionPoints(t),e&&(this.drawSelectionOutline(t),this.drawResizeHandles(t)),t.restore()}drawRounded(t){const e=this.x-this.width/2,i=this.y-this.height/2,s=this.height/2;t.beginPath(),t.moveTo(e+s,i),t.lineTo(e+this.width-s,i),t.arcTo(e+this.width,i,e+this.width,i+s,s),t.lineTo(e+this.width,i+this.height-s),t.arcTo(e+this.width,i+this.height,e+this.width-s,i+this.height,s),t.lineTo(e+s,i+this.height),t.arcTo(e,i+this.height,e,i+this.height-s,s),t.lineTo(e,i+s),t.arcTo(e,i,e+s,i,s),t.closePath(),t.fill(),t.stroke()}drawRectangle(t){const e=this.x-this.width/2,i=this.y-this.height/2;t.fillRect(e,i,this.width,this.height),t.strokeRect(e,i,this.width,this.height)}drawDiamond(t){t.beginPath(),t.moveTo(this.x,this.y-this.height/2),t.lineTo(this.x+this.width/2,this.y),t.lineTo(this.x,this.y+this.height/2),t.lineTo(this.x-this.width/2,this.y),t.closePath(),t.fill(),t.stroke()}drawText(t){t.fillStyle="#000",t.font="14px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,this.x,this.y)}drawConnectionPoints(t){const e=this.getConnectionPoints();for(let i of e)t.fillStyle="#000",t.strokeStyle="#fff",t.lineWidth=2,t.beginPath(),t.arc(i.x,i.y,8,0,2*Math.PI),t.fill(),t.stroke(),t.strokeStyle="#fff",t.lineWidth=2,t.lineCap="round",t.beginPath(),t.moveTo(i.x-4,i.y),t.lineTo(i.x+4,i.y),t.stroke(),t.beginPath(),t.moveTo(i.x,i.y-4),t.lineTo(i.x,i.y+4),t.stroke()}drawSelectionOutline(t){switch(t.strokeStyle="#2196F3",t.lineWidth=3,t.setLineDash([5,5]),this.type){case"start":case"end":this.drawRoundedSelectionOutline(t);break;case"decision":this.drawDiamondSelectionOutline(t);break;default:this.drawRectangleSelectionOutline(t)}t.setLineDash([])}drawRoundedSelectionOutline(t){const e=this.x-this.width/2,i=this.y-this.height/2,s=this.height/2;t.beginPath(),t.moveTo(e+s,i),t.lineTo(e+this.width-s,i),t.arcTo(e+this.width,i,e+this.width,i+s,s),t.lineTo(e+this.width,i+this.height-s),t.arcTo(e+this.width,i+this.height,e+this.width-s,i+this.height,s),t.lineTo(e+s,i+this.height),t.arcTo(e,i+this.height,e,i+this.height-s,s),t.lineTo(e,i+s),t.arcTo(e,i,e+s,i,s),t.closePath(),t.stroke()}drawDiamondSelectionOutline(t){t.beginPath(),t.moveTo(this.x,this.y-this.height/2-5),t.lineTo(this.x+this.width/2+5,this.y),t.lineTo(this.x,this.y+this.height/2+5),t.lineTo(this.x-this.width/2-5,this.y),t.closePath(),t.stroke()}drawRectangleSelectionOutline(t){t.strokeRect(this.x-this.width/2-5,this.y-this.height/2-5,this.width+10,this.height+10)}drawResizeHandles(t){const e=this.getResizeHandles();t.fillStyle="#2196F3",t.strokeStyle="#fff",t.lineWidth=2;for(let i of e)t.fillRect(i.x-4,i.y-4,8,8),t.strokeRect(i.x-4,i.y-4,8,8)}getFillColor(){switch(this.type){case"start":return"#90EE90";case"end":return"#FFB6C1";case"process":return"#87CEEB";case"decision":return"#FFD700";default:return"#FFF"}}}class Connection{constructor(t,e,i,s,n){this.id=t,this.fromNode=e,this.fromPort=i,this.toNode=s,this.toPort=n,this.selected=!1}getPortPosition(t,e){switch(e){case"top":return{x:t.x,y:t.y-t.height/2};case"right":return{x:t.x+t.width/2,y:t.y};case"bottom":return{x:t.x,y:t.y+t.height/2};case"left":return{x:t.x-t.width/2,y:t.y};default:return{x:t.x,y:t.y}}}isNearPoint(t,e,i=1,s=15){const n=s/i,o=this.getPortPosition(this.fromNode,this.fromPort),h=this.getPortPosition(this.toNode,this.toPort);if(this.distanceToPoint(t,e,o.x,o.y)<n)return!0;if(this.distanceToPoint(t,e,h.x,h.y)<n)return!0;const r=this.pointToLineDistance(t,e,o.x,o.y,h.x,h.y),d=(o.x+h.x)/2,c=(o.y+h.y)/2;return this.distanceToPoint(t,e,d,c)<2*n||r<n}distanceToPoint(t,e,i,s){return Math.sqrt((i-t)**2+(s-e)**2)}pointToLineDistance(t,e,i,s,n,o){const h=n-i,r=o-s,d=h*h+r*r;if(0===d)return Math.sqrt((t-i)*(t-i)+(e-s)*(e-s));let c=((t-i)*h+(e-s)*r)/d;c=Math.max(0,Math.min(1,c));const a=i+c*h,l=s+c*r;return Math.sqrt((t-a)*(t-a)+(e-l)*(e-l))}draw(t,e=!1){t.save();const i=this.getPortPosition(this.fromNode,this.fromPort),s=this.getPortPosition(this.toNode,this.toPort);t.strokeStyle="#000",t.lineWidth=e?3:2,t.setLineDash([]),this.drawConnectionLine(t,i,s),t.restore()}drawConnectionLine(t,e,i){const s=this.needsBendingPath(e,i);if(t.beginPath(),t.moveTo(e.x,e.y),s){const s=50,n=this.getControlPoint(e,this.fromPort,s),o=this.getControlPoint(i,this.toPort,s);t.bezierCurveTo(n.x,n.y,o.x,o.y,i.x,i.y)}else t.lineTo(i.x,i.y);t.stroke()}getControlPoint(t,e,i){switch(e){case"right":return{x:t.x+i,y:t.y};case"left":return{x:t.x-i,y:t.y};case"top":return{x:t.x,y:t.y-i};case"bottom":return{x:t.x,y:t.y+i};default:return t}}needsBendingPath(t,e){const i=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y);return i>50||s>50}}return{Canvas:class{constructor(t,e={}){if(this.container=document.getElementById(t),!this.container)throw new Error(`Container element '${t}' not found!`);this.options={mode:e.mode||"edit",width:e.width||null,height:e.height||null,readonly:e.readonly||!1,pixelRatio:e.pixelRatio||window.devicePixelRatio||1,minZoom:e.minZoom||.1,maxZoom:e.maxZoom||5},this.panX=0,this.panY=0,this.zoom=1,this.isPanning=!1,this.panStartX=0,this.panStartY=0,this.nodes=[],this.connections=[],this.nodeIdCounter=0,this.connectionIdCounter=0,this.selectedNode=null,this.selectedConnection=null,this.isDragging=!1,this.dragOffsetX=0,this.dragOffsetY=0,this.isResizing=!1,this.resizeHandle=null,this.resizeStartWidth=0,this.resizeStartHeight=0,this.resizeStartX=0,this.resizeStartY=0,this.resizeStartNodeX=0,this.resizeStartNodeY=0,this.isConnecting=!1,this.connectionStart=null,this.connectionStartPort=null,this.tempConnectionEnd=null,this.isReconnecting=!1,this.reconnectingConnection=null,this.reconnectingEnd=null,this.editingNode=null,this.textInput=null,this.originalNodeText=null,this.history=[],this.historyIndex=-1,this.maxHistorySize=50,this.clipboard=null,this.init(),this.setupResizeObserver(),this.saveState()}init(){this.container.style.position=this.container.style.position||"relative",this.container.style.width=this.container.style.width||"100%",this.container.style.height=this.container.style.height||"100%",this.canvas=document.createElement("canvas"),this.canvas.style.border="1px solid #ccc",this.canvas.style.cursor="grab",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.display="block",this.canvas.style.boxSizing="border-box",this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas),this.updateCanvasSize(),this.options.readonly||(this.canvas.addEventListener("mousedown",t=>this.handleMouseDown(t)),this.canvas.addEventListener("mousemove",t=>this.handleMouseMove(t)),this.canvas.addEventListener("mouseup",t=>this.handleMouseUp(t)),this.canvas.addEventListener("dblclick",t=>this.handleDoubleClick(t)),this.canvas.addEventListener("wheel",t=>this.handleWheel(t)),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("keydown",t=>this.handleKeyDown(t)),document.addEventListener("keyup",t=>this.handleKeyUp(t))),this.render()}setupResizeObserver(){"undefined"!=typeof ResizeObserver?(this.resizeObserver=new ResizeObserver(()=>{this.updateCanvasSize(),this.render()}),this.resizeObserver.observe(this.container)):window.addEventListener("resize",()=>{this.updateCanvasSize(),this.render()})}updateCanvasSize(){const t=this.container.getBoundingClientRect(),e=this.options.width||t.width,i=this.options.height||t.height,s=this.options.pixelRatio;this.canvas.width=e*s,this.canvas.height=i*s,this.canvas.style.width=e+"px",this.canvas.style.height=i+"px",this.logicalWidth=e,this.logicalHeight=i}screenToWorld(t,e){return{x:(t-this.panX)/this.zoom,y:(e-this.panY)/this.zoom}}worldToScreen(t,e){return{x:t*this.zoom+this.panX,y:e*this.zoom+this.panY}}zoomAt(t,e,i){const s=this.screenToWorld(t,e),n=i>0?1.1:.9;this.zoom=Math.max(this.options.minZoom,Math.min(this.options.maxZoom,this.zoom*n));const o=this.screenToWorld(t,e);this.panX+=(o.x-s.x)*this.zoom,this.panY+=(o.y-s.y)*this.zoom}resetView(){this.panX=0,this.panY=0,this.zoom=1,this.render()}fitToContent(){if(0===this.nodes.length)return;let t=1/0,e=1/0,i=-1/0,s=-1/0;for(let n of this.nodes)t=Math.min(t,n.x-n.width/2),e=Math.min(e,n.y-n.height/2),i=Math.max(i,n.x+n.width/2),s=Math.max(s,n.y+n.height/2);const n=i-t,o=s-e,h=(this.logicalWidth-100)/n,r=(this.logicalHeight-100)/o;this.zoom=Math.min(h,r,1);const d=(t+i)/2,c=(e+s)/2;this.panX=this.logicalWidth/2-d*this.zoom,this.panY=this.logicalHeight/2-c*this.zoom,this.render()}addNode(t,e,i,s){const n="node-"+this.nodeIdCounter++;if(void 0===i||void 0===s){const t=this.screenToWorld(this.logicalWidth/2,this.logicalHeight/2);i=t.x,s=t.y}const o=new Node(n,t,i,s,e);return this.nodes.push(o),this.render(),this.saveState(),o}deleteNode(t){this.connections=this.connections.filter(e=>e.fromNode!==t&&e.toNode!==t),this.nodes=this.nodes.filter(e=>e!==t),this.selectedNode=null,this.render(),this.saveState()}addConnection(t,e,i,s){if(t===i)return null;for(let n of this.connections)if(n.fromNode===t&&n.toNode===i&&n.fromPort===e&&n.toPort===s)return null;const n="conn-"+this.connectionIdCounter++,o=new Connection(n,t,e,i,s);return this.connections.push(o),this.render(),this.saveState(),o}deleteConnection(t){this.connections=this.connections.filter(e=>e!==t),this.selectedConnection=null,this.render(),this.saveState()}getConnectionEndpointAt(t,e,i=15){const s=i/this.zoom;for(let i of this.connections){const n=i.getPortPosition(i.fromNode,i.fromPort),o=i.getPortPosition(i.toNode,i.toPort);if(Math.sqrt((t-n.x)**2+(e-n.y)**2)<s)return{connection:i,endpoint:"start"};if(Math.sqrt((t-o.x)**2+(e-o.y)**2)<s)return{connection:i,endpoint:"end"}}return null}render(){const t=this.options.pixelRatio;this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.scale(t,t),this.ctx.fillStyle="#f9f9f9",this.ctx.fillRect(0,0,this.logicalWidth,this.logicalHeight),this.ctx.translate(this.panX,this.panY),this.ctx.scale(this.zoom,this.zoom),this.drawGrid();for(let t of this.connections){const e=t===this.selectedConnection;this.isReconnecting&&t===this.reconnectingConnection||t.draw(this.ctx,e)}this.isReconnecting&&this.reconnectingConnection&&this.tempConnectionEnd&&this.drawReconnectionPreview(),this.isConnecting&&this.connectionStart&&this.tempConnectionEnd&&this.drawConnectionPreview();for(let t of this.nodes){const e=t===this.selectedNode;t.draw(this.ctx,e)}this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t),this.drawUIOverlay()}drawGrid(){const t=20,e={left:this.screenToWorld(0,0).x,top:this.screenToWorld(0,0).y,right:this.screenToWorld(this.logicalWidth,this.logicalHeight).x,bottom:this.screenToWorld(this.logicalWidth,this.logicalHeight).y};this.ctx.strokeStyle="#e0e0e0",this.ctx.lineWidth=1/this.zoom;const i=Math.floor(e.left/t)*t,s=Math.ceil(e.right/t)*t,n=Math.floor(e.top/t)*t,o=Math.ceil(e.bottom/t)*t;for(let n=i;n<=s;n+=t)this.ctx.beginPath(),this.ctx.moveTo(n,e.top),this.ctx.lineTo(n,e.bottom),this.ctx.stroke();for(let i=n;i<=o;i+=t)this.ctx.beginPath(),this.ctx.moveTo(e.left,i),this.ctx.lineTo(e.right,i),this.ctx.stroke()}drawUIOverlay(){this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,10,220,100),this.ctx.fillStyle="#fff",this.ctx.font="12px Arial",this.ctx.textAlign="left",this.ctx.fillText(`Zoom: ${(100*this.zoom).toFixed(0)}%`,20,30),this.ctx.fillText(`Pan: (${Math.round(this.panX)}, ${Math.round(this.panY)})`,20,50),this.ctx.fillText("Drag Empty Space: Pan",20,70),this.ctx.fillText("Scroll: Zoom",20,85),this.ctx.fillText("Ctrl+0: Reset | Ctrl+1: Fit",20,100),0===this.nodes.length&&(this.ctx.fillStyle="#999",this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.fillText("Add nodes using buttons below",this.logicalWidth/2,this.logicalHeight/2),this.ctx.fillText("Drag empty space to pan, scroll to zoom",this.logicalWidth/2,this.logicalHeight/2+25))}drawReconnectionPreview(){const t=this.reconnectingConnection;let e,i;"start"===this.reconnectingEnd?(e=this.tempConnectionEnd,i=t.getPortPosition(t.toNode,t.toPort)):(e=t.getPortPosition(t.fromNode,t.fromPort),i=this.tempConnectionEnd),this.ctx.strokeStyle="#000",this.ctx.lineWidth=2/this.zoom,this.ctx.setLineDash([]),this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke()}drawConnectionPreview(){const t=this.connectionStart.getConnectionPoints().find(t=>t.position===this.connectionStartPort);this.ctx.strokeStyle="#000",this.ctx.lineWidth=2/this.zoom,this.ctx.setLineDash([]),this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(this.tempConnectionEnd.x,this.tempConnectionEnd.y),this.ctx.stroke()}clear(){this.nodes=[],this.connections=[],this.selectedNode=null,this.selectedConnection=null,this.nodeIdCounter=0,this.connectionIdCounter=0,this.render()}getMousePos(t){const e=this.canvas.getBoundingClientRect(),i=this.logicalWidth/e.width,s=this.logicalHeight/e.height,n=(t.clientX-e.left)*i,o=(t.clientY-e.top)*s,h=this.screenToWorld(n,o);return{screen:{x:n,y:o},world:{x:h.x,y:h.y}}}handleWheel(t){t.preventDefault();const e=this.getMousePos(t);this.zoomAt(e.screen.x,e.screen.y,-t.deltaY),this.render()}handleMouseDown(t){const e=this.getMousePos(t),i=e.world.x,s=e.world.y;if(1===t.button)return this.startPanning(e.screen.x,e.screen.y),void t.preventDefault();if(0!==t.button)return;if(this.selectedNode){const t=this.selectedNode.isOnResizeHandle(i,s,this.zoom);if(t)return void this.startResizing(t,i,s)}const n=this.getConnectionEndpointAt(i,s);if(n)return void this.startReconnecting(n,i,s);for(let t of this.nodes){const e=t.isOnConnectionPoint(i,s,this.zoom);if(e)return void this.startConnecting(t,e,i,s)}let o=!1;for(let t of this.nodes)if(t.containsPoint(i,s))return this.startDragging(t,i,s),void(o=!0);for(let t of this.connections)if(t.isNearPoint(i,s,this.zoom))return void this.selectConnection(t);this.startPanning(e.screen.x,e.screen.y),this.deselectAll()}handleMouseMove(t){const e=this.getMousePos(t),i=e.world.x,s=e.world.y;if(this.isPanning)this.updatePan(e.screen.x,e.screen.y);else{if(!this.isResizing)return this.isReconnecting||this.isConnecting?(this.tempConnectionEnd={x:i,y:s},void this.render()):void(this.isDragging&&this.selectedNode?this.updateDrag(i,s):this.updateCursor(i,s));this.updateResize(i,s)}}handleMouseUp(t){const e=this.getMousePos(t),i=e.world.x,s=e.world.y;this.isPanning?this.finishPanning():this.isResizing?this.finishResizing():this.isReconnecting?this.finishReconnecting(i,s):this.isConnecting?this.finishConnecting(i,s):this.isDragging&&this.finishDragging()}handleDoubleClick(t){const e=this.getMousePos(t),i=e.world.x,s=e.world.y;for(let t of this.nodes)if(t.containsPoint(i,s))return void this.startEditingNode(t)}startPanning(t,e){this.isPanning=!0,this.panStartX=t-this.panX,this.panStartY=e-this.panY,this.canvas.style.cursor="grabbing"}updatePan(t,e){this.panX=t-this.panStartX,this.panY=e-this.panStartY,this.render()}finishPanning(){this.isPanning=!1,this.canvas.style.cursor="grab"}startResizing(t,e,i){this.isResizing=!0,this.resizeHandle=t.position,this.resizeStartWidth=this.selectedNode.width,this.resizeStartHeight=this.selectedNode.height,this.resizeStartX=e,this.resizeStartY=i,this.resizeStartNodeX=this.selectedNode.x,this.resizeStartNodeY=this.selectedNode.y,this.canvas.style.cursor=this.getResizeCursor(t.position)}updateResize(t,e){const i=t-this.resizeStartX,s=e-this.resizeStartY;switch(this.resizeHandle){case"top-left":const t=Math.max(60,this.resizeStartWidth-i),e=Math.max(40,this.resizeStartHeight-s),n=this.resizeStartWidth-t,o=this.resizeStartHeight-e;this.selectedNode.width=t,this.selectedNode.height=e,this.selectedNode.x=this.resizeStartNodeX-n/2,this.selectedNode.y=this.resizeStartNodeY-o/2;break;case"top-right":const h=Math.max(60,this.resizeStartWidth+i),r=Math.max(40,this.resizeStartHeight-s),d=h-this.resizeStartWidth,c=this.resizeStartHeight-r;this.selectedNode.width=h,this.selectedNode.height=r,this.selectedNode.x=this.resizeStartNodeX+d/2,this.selectedNode.y=this.resizeStartNodeY-c/2;break;case"bottom-right":const a=Math.max(60,this.resizeStartWidth+i),l=Math.max(40,this.resizeStartHeight+s),g=a-this.resizeStartWidth,u=l-this.resizeStartHeight;this.selectedNode.width=a,this.selectedNode.height=l,this.selectedNode.x=this.resizeStartNodeX+g/2,this.selectedNode.y=this.resizeStartNodeY+u/2;break;case"bottom-left":const x=Math.max(60,this.resizeStartWidth-i),y=Math.max(40,this.resizeStartHeight+s),p=this.resizeStartWidth-x,f=y-this.resizeStartHeight;this.selectedNode.width=x,this.selectedNode.height=y,this.selectedNode.x=this.resizeStartNodeX-p/2,this.selectedNode.y=this.resizeStartNodeY+f/2}this.render()}finishResizing(){this.isResizing=!1,this.resizeHandle=null,this.canvas.style.cursor="move",this.saveState()}startReconnecting(t,e,i){this.isReconnecting=!0,this.reconnectingConnection=t.connection,this.reconnectingEnd=t.endpoint,this.tempConnectionEnd={x:e,y:i},this.canvas.style.cursor="crosshair",this.selectedConnection=t.connection,this.selectedNode=null,this.render()}finishReconnecting(t,e){for(let i of this.nodes)if(i.containsPoint(t,e)){const s=i.getClosestConnectionPoint(t,e);"start"===this.reconnectingEnd?i!==this.reconnectingConnection.toNode&&(this.reconnectingConnection.fromNode=i,this.reconnectingConnection.fromPort=s.position,this.saveState()):i!==this.reconnectingConnection.fromNode&&(this.reconnectingConnection.toNode=i,this.reconnectingConnection.toPort=s.position,this.saveState());break}this.isReconnecting=!1,this.reconnectingConnection=null,this.reconnectingEnd=null,this.tempConnectionEnd=null,this.canvas.style.cursor="grab",this.render()}startConnecting(t,e,i,s){this.isConnecting=!0,this.connectionStart=t,this.connectionStartPort=e.position,this.tempConnectionEnd={x:i,y:s},this.canvas.style.cursor="crosshair"}finishConnecting(t,e){for(let i of this.nodes)if(i!==this.connectionStart&&i.containsPoint(t,e)){const s=i.getClosestConnectionPoint(t,e);this.addConnection(this.connectionStart,this.connectionStartPort,i,s.position);break}this.isConnecting=!1,this.connectionStart=null,this.connectionStartPort=null,this.tempConnectionEnd=null,this.canvas.style.cursor="grab",this.render()}startDragging(t,e,i){this.selectedNode=t,this.selectedConnection=null,this.isDragging=!0,this.dragOffsetX=e-t.x,this.dragOffsetY=i-t.y,this.canvas.style.cursor="grabbing",this.render()}updateDrag(t,e){this.selectedNode.x=t-this.dragOffsetX,this.selectedNode.y=e-this.dragOffsetY,this.render()}finishDragging(){this.isDragging=!1,this.canvas.style.cursor="move",this.saveState()}selectConnection(t){this.selectedConnection=t,this.selectedNode=null,this.render()}deselectAll(){this.selectedNode=null,this.selectedConnection=null,this.render()}updateCursor(t,e){if(!(this.isPanning||this.isDragging||this.isConnecting||this.isReconnecting||this.isResizing)){if(this.selectedNode){const i=this.selectedNode.isOnResizeHandle(t,e,this.zoom);if(i)return void(this.canvas.style.cursor=this.getResizeCursor(i.position));if(this.selectedNode.isOnConnectionPoint(t,e,this.zoom))return void(this.canvas.style.cursor="pointer")}for(let i of this.nodes)if(i.isOnConnectionPoint(t,e,this.zoom))return void(this.canvas.style.cursor="pointer");if(this.getConnectionEndpointAt(t,e))this.canvas.style.cursor="pointer";else{for(let i of this.nodes)if(i.containsPoint(t,e))return void(this.canvas.style.cursor="move");for(let i of this.connections)if(i.isNearPoint(t,e,this.zoom))return void(this.canvas.style.cursor="pointer");this.canvas.style.cursor="grab"}}}getResizeCursor(t){switch(t){case"top-left":case"bottom-right":return"nwse-resize";case"top-right":case"bottom-left":return"nesw-resize";default:return"default"}}startEditingNode(t){this.editingNode=t,this.originalNodeText=t.text,t.text="",this.render();const e=this.worldToScreen(t.x,t.y),i=this.canvas.getBoundingClientRect(),s=i.width/this.logicalWidth,n=i.height/this.logicalHeight;this.textInput=document.createElement("input"),this.textInput.type="text",this.textInput.value="",this.textInput.style.cssText=`\n      position: absolute;\n      left: ${i.left+(e.x-t.width*this.zoom/2+10*this.zoom)*s}px;\n      top: ${i.top+(e.y-10*this.zoom)*n}px;\n      width: ${(t.width-20)*this.zoom*s}px;\n      height: 20px;\n      font-size: ${14*this.zoom}px;\n      font-family: Arial;\n      text-align: center;\n      padding: 4px;\n      margin: 0;\n      border: none !important;\n      outline: none !important;\n      background: transparent;\n      color: #000;\n      z-index: 1000;\n    `,document.body.appendChild(this.textInput),this.textInput.focus(),this.textInput.addEventListener("blur",()=>this.finishEditingNode()),this.textInput.addEventListener("keydown",t=>{"Enter"===t.key?this.finishEditingNode():"Escape"===t.key&&this.cancelEditingNode()})}finishEditingNode(){this.editingNode&&this.textInput&&(""===this.textInput.value.trim()?this.editingNode.text=this.originalNodeText:this.editingNode.text=this.textInput.value,document.body.removeChild(this.textInput),this.textInput=null,this.editingNode=null,this.originalNodeText=null,this.render(),this.saveState())}cancelEditingNode(){this.textInput&&(this.editingNode&&void 0!==this.originalNodeText&&(this.editingNode.text=this.originalNodeText),document.body.removeChild(this.textInput),this.textInput=null,this.editingNode=null,this.originalNodeText=null,this.render())}handleKeyDown(t){if(this.editingNode)return;const e=navigator.platform.toUpperCase().indexOf("MAC")>=0,i=e?t.metaKey:t.ctrlKey;return i&&"0"===t.key?(this.resetView(),void t.preventDefault()):i&&"1"===t.key?(this.fitToContent(),void t.preventDefault()):i&&"z"===t.key&&!t.shiftKey?(this.undo(),void t.preventDefault()):i&&"z"===t.key&&t.shiftKey||!e&&i&&"y"===t.key?(this.redo(),void t.preventDefault()):i&&"c"===t.key?(this.copySelected(),void t.preventDefault()):i&&"v"===t.key?(this.paste(),void t.preventDefault()):void("Delete"!==t.key&&"Backspace"!==t.key||(this.selectedNode?(this.deleteNode(this.selectedNode),t.preventDefault()):this.selectedConnection&&(this.deleteConnection(this.selectedConnection),t.preventDefault())))}handleKeyUp(t){}saveState(){this.history=this.history.slice(0,this.historyIndex+1);const t={nodes:this.nodes.map(t=>({id:t.id,type:t.type,x:t.x,y:t.y,text:t.text,width:t.width,height:t.height})),connections:this.connections.map(t=>({id:t.id,fromNodeId:t.fromNode.id,fromPort:t.fromPort,toNodeId:t.toNode.id,toPort:t.toPort}))};this.history.push(t),this.history.length>this.maxHistorySize?this.history.shift():this.historyIndex++}restoreState(t){this.nodes=[],this.connections=[],this.selectedNode=null,this.selectedConnection=null;const e=new Map;t.nodes.forEach(t=>{const i=new Node(t.id,t.type,t.x,t.y,t.text);i.width=t.width,i.height=t.height,this.nodes.push(i),e.set(t.id,i)});const i=Math.max(0,...t.nodes.map(t=>parseInt(t.id.split("-")[1])||0));this.nodeIdCounter=i+1,t.connections.forEach(t=>{const i=e.get(t.fromNodeId),s=e.get(t.toNodeId);if(i&&s){const e=new Connection(t.id,i,t.fromPort,s,t.toPort);this.connections.push(e)}});const s=Math.max(0,...t.connections.map(t=>parseInt(t.id.split("-")[1])||0));this.connectionIdCounter=s+1,this.render()}undo(){this.historyIndex>0&&(this.historyIndex--,this.restoreState(this.history[this.historyIndex]))}redo(){this.historyIndex<this.history.length-1&&(this.historyIndex++,this.restoreState(this.history[this.historyIndex]))}copySelected(){this.selectedNode&&(this.clipboard={type:"node",data:{type:this.selectedNode.type,text:this.selectedNode.text,width:this.selectedNode.width,height:this.selectedNode.height}})}paste(){if(this.clipboard&&"node"===this.clipboard.type){const t=this.clipboard.data,e=this.addNode(t.type,t.text,this.selectedNode?this.selectedNode.x+30:void 0,this.selectedNode?this.selectedNode.y+30:void 0);e.width=t.width,e.height=t.height,this.selectedNode=e,this.saveState()}}exportToJSON(){const t={nodes:this.nodes.map(t=>({id:t.id,type:t.type,x:t.x,y:t.y,text:t.text,width:t.width,height:t.height})),connections:this.connections.map(t=>({id:t.id,fromNodeId:t.fromNode.id,fromPort:t.fromPort,toNodeId:t.toNode.id,toPort:t.toPort}))};return JSON.stringify(t,null,2)}importFromJSON(t){const e=JSON.parse(t);this.clear();const i=new Map;e.nodes.forEach(t=>{const e=new Node(t.id,t.type,t.x,t.y,t.text);e.width=t.width,e.height=t.height,this.nodes.push(e),i.set(t.id,e)});const s=Math.max(0,...e.nodes.map(t=>parseInt(t.id.split("-")[1])||0));this.nodeIdCounter=s+1,e.connections.forEach(t=>{const e=i.get(t.fromNodeId),s=i.get(t.toNodeId);if(e&&s){const i=new Connection(t.id,e,t.fromPort,s,t.toPort);this.connections.push(i)}});const n=Math.max(0,...e.connections.map(t=>parseInt(t.id.split("-")[1])||0));this.connectionIdCounter=n+1,this.render()}exportToPNG(){return this.canvas.toDataURL("image/png")}destroy(){this.canvas&&(this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("dblclick",this.handleDoubleClick),this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("contextmenu",t=>t.preventDefault())),document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.resizeObserver&&this.resizeObserver.disconnect(),this.textInput&&document.body.contains(this.textInput)&&document.body.removeChild(this.textInput),this.canvas&&this.canvas.remove()}},Node:Node,Connection:Connection}});